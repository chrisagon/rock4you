#!/usr/bin/env node

/**
 * Script de d√©ploiement automatis√© pour Rock4you
 * Usage: node scripts/deploy.js [--env=production|staging] [--skip-tests]
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const readline = require('readline');

// Configuration
const args = process.argv.slice(2);
const envArg = args.find(arg => arg.startsWith('--env='));
const environment = envArg ? envArg.split('=')[1] : 'staging';
const skipTests = args.includes('--skip-tests');
const forceYes = args.includes('--yes') || args.includes('-y');

// Couleurs pour les logs
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  magenta: '\x1b[35m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function executeCommand(command, description, options = {}) {
  log(`\nüîÑ ${description}...`, 'cyan');
  try {
    const output = execSync(command, { 
      encoding: 'utf8', 
      stdio: options.silent ? 'pipe' : 'inherit',
      cwd: options.cwd || process.cwd()
    });
    log(`‚úÖ ${description} termin√©`, 'green');
    return { success: true, output };
  } catch (error) {
    log(`‚ùå Erreur lors de ${description.toLowerCase()}:`, 'red');
    if (!options.silent) {
      console.error(error.stdout || error.message);
    }
    return { success: false, error };
  }
}

function askQuestion(question) {
  if (forceYes) return Promise.resolve('y');
  
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  return new Promise((resolve) => {
    rl.question(`${colors.yellow}${question} (y/N): ${colors.reset}`, (answer) => {
      rl.close();
      resolve(answer.toLowerCase());
    });
  });
}

async function checkPrerequisites() {
  log('üîç V√©rification des pr√©requis', 'magenta');
  
  // V√©rifier Wrangler
  try {
    const wranglerVersion = execSync('wrangler --version', { encoding: 'utf8' }).trim();
    log(`‚úÖ Wrangler: ${wranglerVersion}`, 'green');
  } catch (error) {
    log('‚ùå Wrangler CLI non trouv√©. Installez-le avec: npm install -g wrangler', 'red');
    return false;
  }

  // V√©rifier l'authentification Cloudflare
  try {
    execSync('wrangler whoami', { encoding: 'utf8', stdio: 'pipe' });
    log('‚úÖ Authentification Cloudflare OK', 'green');
  } catch (error) {
    log('‚ùå Non authentifi√© sur Cloudflare. Ex√©cutez: wrangler auth login', 'red');
    return false;
  }

  // V√©rifier la configuration wrangler.toml
  const wranglerPath = path.join('worker', 'wrangler.toml');
  if (!fs.existsSync(wranglerPath)) {
    log('‚ùå Fichier worker/wrangler.toml non trouv√©', 'red');
    return false;
  }
  log('‚úÖ Configuration wrangler.toml trouv√©e', 'green');

  return true;
}

async function runDatabaseMigration() {
  log('\nüóÑÔ∏è  Migration de la base de donn√©es', 'magenta');
  
  const isLocal = environment === 'local';
  const migrationCommand = `node scripts/migrate.js ${isLocal ? '--local' : ''}`;
  
  const result = executeCommand(migrationCommand, 'Migration de la base de donn√©es', { cwd: 'worker' });
  return result.success;
}

async function runBackendTests() {
  if (skipTests) {
    log('\n‚è≠Ô∏è  Tests backend ignor√©s (--skip-tests)', 'yellow');
    return true;
  }

  log('\nüß™ Tests backend', 'magenta');
  
  // D√©marrer le worker en local pour les tests
  log('D√©marrage du worker local pour les tests...', 'cyan');
  
  // D√©tection de la plateforme pour la commande npm
  const isWindows = process.platform === 'win32';
  const npmCommand = isWindows ? 'npm.cmd' : 'npm';
  
  const workerProcess = require('child_process').spawn(npmCommand, ['run', 'dev'], {
    cwd: 'worker',
    stdio: 'pipe',
    shell: isWindows
  });

  // Attendre que le worker soit pr√™t
  await new Promise(resolve => setTimeout(resolve, 8000));

  try {
    const result = executeCommand('node scripts/test-api.js --local', 'Tests API', { cwd: 'worker' });
    workerProcess.kill();
    return result.success;
  } catch (error) {
    workerProcess.kill();
    return false;
  }
}

async function deployWorker() {
  log('\nüöÄ D√©ploiement du Worker', 'magenta');
  
  const deployCommand = environment === 'production' 
    ? 'wrangler deploy --env production'
    : 'wrangler deploy';
  
  const result = executeCommand(deployCommand, 'D√©ploiement du Worker', { cwd: 'worker' });
  
  if (result.success) {
    // Extraire l'URL du worker depuis la sortie
    const output = result.output || '';
    const urlMatch = output.match(/https:\/\/[^\s]+/);
    if (urlMatch) {
      const workerUrl = urlMatch[0];
      log(`üåê Worker d√©ploy√© sur: ${workerUrl}`, 'green');
      return { success: true, url: workerUrl };
    }
  }
  
  return { success: result.success };
}

async function testDeployedAPI(workerUrl) {
  if (skipTests || !workerUrl) {
    log('\n‚è≠Ô∏è  Tests API d√©ploy√©e ignor√©s', 'yellow');
    return true;
  }

  log('\nüß™ Tests de l\'API d√©ploy√©e', 'magenta');
  
  // Attendre que le d√©ploiement soit propag√©
  log('Attente de la propagation du d√©ploiement...', 'cyan');
  await new Promise(resolve => setTimeout(resolve, 10000));
  
  const result = executeCommand(
    `node scripts/test-api.js --url=${workerUrl}`, 
    'Tests API d√©ploy√©e', 
    { cwd: 'worker' }
  );
  
  return result.success;
}

async function configureFrontend(workerUrl) {
  log('\n‚öôÔ∏è  Configuration du frontend', 'magenta');
  
  if (!workerUrl) {
    log('‚ö†Ô∏è  URL du worker non disponible, configuration manuelle requise', 'yellow');
    return false;
  }

  const envContent = `EXPO_PUBLIC_API_URL=${workerUrl}\n`;
  const envPath = '.env.local';
  
  try {
    fs.writeFileSync(envPath, envContent);
    log(`‚úÖ Fichier .env.local mis √† jour avec: ${workerUrl}`, 'green');
    return true;
  } catch (error) {
    log(`‚ùå Erreur lors de la mise √† jour de .env.local: ${error.message}`, 'red');
    return false;
  }
}

async function runFrontendTests(workerUrl) {
  if (skipTests) {
    log('\n‚è≠Ô∏è  Tests frontend ignor√©s (--skip-tests)', 'yellow');
    return true;
  }

  log('\nüß™ Tests frontend', 'magenta');
  
  const apiUrl = workerUrl || 'http://localhost:8787';
  const result = executeCommand(
    `node scripts/test-frontend.js --api-url=${apiUrl}`, 
    'Tests frontend'
  );
  
  return result.success;
}

async function generateDeploymentReport(results) {
  log('\nüìä Rapport de d√©ploiement', 'magenta');
  
  const steps = [
    'Pr√©requis',
    'Migration DB',
    'Tests backend',
    'D√©ploiement Worker',
    'Tests API d√©ploy√©e',
    'Configuration frontend',
    'Tests frontend'
  ];
  
  const totalSteps = steps.length;
  const successfulSteps = steps.filter(step => results[step]).length;
  
  log(`‚úÖ √âtapes r√©ussies: ${successfulSteps}/${totalSteps}`, 'green');
  log(`‚ùå √âtapes √©chou√©es: ${totalSteps - successfulSteps}/${totalSteps}`, 
      successfulSteps === totalSteps ? 'green' : 'red');
  
  log('\nD√©tail des √©tapes:', 'blue');
  steps.forEach(step => {
    const status = results[step] ? '‚úÖ' : '‚ùå';
    const color = results[step] ? 'green' : 'red';
    log(`  ${status} ${step}`, color);
  });
  
  if (successfulSteps === totalSteps) {
    log('\nüéâ D√©ploiement r√©ussi!', 'green');
    log('\nüì± Prochaines √©tapes:', 'cyan');
    log('  1. Testez l\'application avec: npm run dev', 'blue');
    log('  2. V√©rifiez l\'inscription/connexion', 'blue');
    log('  3. Testez la gestion des favoris', 'blue');
    
    if (results.workerUrl) {
      log(`\nüåê API disponible sur: ${results.workerUrl}`, 'green');
    }
  } else {
    log('\n‚ö†Ô∏è  D√©ploiement partiellement √©chou√©', 'yellow');
    log('Consultez les erreurs ci-dessus pour plus de d√©tails', 'yellow');
  }
  
  return successfulSteps === totalSteps;
}

async function main() {
  log('üöÄ D√©ploiement automatis√© Rock4you', 'magenta');
  log(`üìç Environnement: ${environment}`, 'blue');
  log(`üß™ Tests: ${skipTests ? 'Ignor√©s' : 'Activ√©s'}`, 'blue');
  
  // Confirmation avant d√©ploiement
  if (!forceYes) {
    const confirm = await askQuestion(`Confirmer le d√©ploiement en ${environment}?`);
    if (confirm !== 'y' && confirm !== 'yes') {
      log('D√©ploiement annul√©', 'yellow');
      process.exit(0);
    }
  }
  
  const results = {};
  let workerUrl = null;
  
  // √âtapes de d√©ploiement
  results['Pr√©requis'] = await checkPrerequisites();
  if (!results['Pr√©requis']) {
    log('\n‚ùå Pr√©requis non satisfaits, arr√™t du d√©ploiement', 'red');
    process.exit(1);
  }
  
  results['Migration DB'] = await runDatabaseMigration();
  results['Tests backend'] = await runBackendTests();
  
  const deployResult = await deployWorker();
  results['D√©ploiement Worker'] = deployResult.success;
  if (deployResult.url) {
    workerUrl = deployResult.url;
    results.workerUrl = workerUrl;
  }
  
  results['Tests API d√©ploy√©e'] = await testDeployedAPI(workerUrl);
  results['Configuration frontend'] = await configureFrontend(workerUrl);
  results['Tests frontend'] = await runFrontendTests(workerUrl);
  
  const success = await generateDeploymentReport(results);
  process.exit(success ? 0 : 1);
}

// Affichage de l'aide
if (args.includes('--help') || args.includes('-h')) {
  console.log(`
Script de d√©ploiement automatis√© pour Rock4you

Usage: node scripts/deploy.js [options]

Options:
  --env=ENV        Environnement de d√©ploiement (staging|production, d√©faut: staging)
  --skip-tests     Ignorer les tests automatis√©s
  --yes, -y        Confirmer automatiquement toutes les questions
  --help, -h       Afficher cette aide

Exemples:
  node scripts/deploy.js                    # D√©ploiement staging avec tests
  node scripts/deploy.js --env=production   # D√©ploiement production
  node scripts/deploy.js --skip-tests -y    # D√©ploiement rapide sans tests
  `);
  process.exit(0);
}

main().catch(error => {
  log(`\n‚ùå Erreur inattendue: ${error.message}`, 'red');
  process.exit(1);
});